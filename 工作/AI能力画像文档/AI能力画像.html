<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI能力画像助手</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Inter字体 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 自定义加载动画 */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* 表格单元格样式 */
        th, td {
            @apply px-4 py-3 text-left text-sm;
        }
        th {
            @apply font-semibold bg-gray-100;
        }
        td {
            @apply border-b border-gray-200;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl p-6 md:p-10">
        
        <!-- 标题和描述 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AI能力画像文档整理助手</h1>
            <p class="text-gray-600">请粘贴您的表格数据（支持Excel、CSV等直接复制），助手将逐行分析并生成画像。</p>
        </div>

        <!-- 1. 输入区域 -->
        <div class="mb-6">
            <label for="inputData" class="block text-sm font-medium text-gray-700 mb-2">粘贴表格数据 (A列:项目名称, B列:工厂名称, C列:项目目标)</label>
            <textarea id="inputData" rows="8"
                class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                placeholder="示例:
项目A	工厂B	目标C
项目X	工厂Y	目标Z
..."></textarea>
        </div>

        <!-- 2. 控制按钮 -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
            <button id="processButton"
                class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 001.414 1.414L9 11.414V14a1 1 0 102 0v-2.586l.293.293a1 1 0 001.414-1.414l-3-3z" clip-rule="evenodd" />
                </svg>
                开始处理
            </button>
            <button id="copyButton"
                class="w-full sm:w-auto px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center gap-2"
                style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                复制结果 (TSV)
            </button>
        </div>

        <!-- 3. 状态和消息提示 -->
        <div id="statusMessage" class="text-center mb-6 h-6">
            <!-- 状态信息将在这里显示 -->
        </div>

        <!-- 4. 输出表格 -->
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
            <table class="min-w-full divide-y divide-gray-200" id="resultTable">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="w-1/12">A: 项目名称</th>
                        <th class="w-1/12">B: 工厂名称</th>
                        <th class="w-1/12">C: 项目目标</th>
                        <th class="w-2/12">D: 应用场景简述</th>
                        <th class="w-2/12">E: 处理对象 (输入)</th>
                        <th class="w-2/12">F: 核心功能</th>
                        <th class="w-2/12">G: 输出形式/接口</th>
                        <th class="w-1/12">H: 部署方式</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="resultBody">
                    <!-- 结果将在这里动态插入 -->
                </tbody>
            </table>
        </div>
        
        <!-- 隐藏的文本区域，用于复制 -->
        <textarea id="copyHelper" class="absolute -left-full"></textarea>

    </div>

    <script type(module)>
        // 获取DOM元素
        const inputDataEl = document.getElementById('inputData');
        const processButton = document.getElementById('processButton');
        const copyButton = document.getElementById('copyButton');
        const statusMessageEl = document.getElementById('statusMessage');
        const resultBodyEl = document.getElementById('resultBody');
        const copyHelperEl = document.getElementById('copyHelper');

        // AI处理逻辑
        processButton.addEventListener('click', async () => {
            const inputText = inputDataEl.value.trim();
            if (!inputText) {
                showStatus('请输入数据后再试。', 'error');
                return;
            }

            // 解析输入数据 (按行分割，再按Tab或逗号分割)
            const rows = inputText.split('\n')
                .filter(row => row.trim() !== '')
                .map(row => row.split(/\t|,/));

            // 验证输入格式
            if (rows.some(row => row.length < 3)) {
                showStatus('输入格式错误。请确保每行至少包含A、B、C三列。', 'error');
                return;
            }

            // 禁用按钮，清空旧数据
            setLoading(true);
            resultBodyEl.innerHTML = '';
            copyButton.style.display = 'none';
            let processedCount = 0;

            // 逐行处理
            for (const row of rows) {
                const [projectName, factory, goal] = row;
                
                // 更新状态
                showStatus(`正在处理第 ${processedCount + 1} / ${rows.length} 行: ${projectName}...`, 'loading');

                try {
                    // 调用Gemini API
                    const aiResult = await callGeminiAPI(projectName, factory, goal);

                    // 创建并插入新行
                    const newRow = createResultRow(projectName, factory, goal, aiResult);
                    resultBodyEl.appendChild(newRow);
                    
                    processedCount++;

                } catch (error) {
                    console.error('API call failed:', error);
                    showStatus(`处理 "${projectName}" 时出错: ${error.message}`, 'error');
                    // 即使出错也继续处理下一行
                    const errorRow = createErrorRow(projectName, factory, goal, error.message);
                    resultBodyEl.appendChild(errorRow);
                }
            }

            // 处理完成
            setLoading(false);
            showStatus(`处理完成！共 ${processedCount} / ${rows.length} 行成功。`, 'success');
            if (processedCount > 0) {
                copyButton.style.display = 'flex';
            }
        });

        // 复制按钮逻辑
        copyButton.addEventListener('click', () => {
            let tsvContent = "A: 项目名称\tB: 工厂名称\tC: 项目目标\tD: 应用场景简述\tE: 处理对象 (输入)\tF: 核心功能\tG: 输出形式/接口\tH: 部署方式\n";
            
            const rows = resultBodyEl.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 8) {
                    const rowData = Array.from(cells).map(cell => {
                        // 特殊处理F列的列表
                        if (cell.id === 'core-functions') {
                            const items = Array.from(cell.querySelectorAll('li')).map(li => li.textContent);
                            return `"${items.join('; ')}"`;
                        }
                        return `"${cell.textContent.replace(/"/g, '""')}"`;
                    });
                    tsvContent += rowData.join('\t') + '\n';
                }
            });

            copyHelperEl.value = tsvContent;
            copyHelperEl.select();
            
            try {
                // 使用 document.execCommand 是因为 navigator.clipboard 在iframe中可能受限
                document.execCommand('copy');
                showStatus('已复制到剪贴板!', 'success');
            } catch (err) {
                console.error('复制失败: ', err);
                showStatus('复制失败。请检查浏览器权限。', 'error');
            }
        });


        // -----------------------------
        // Gemini API 调用函数
        // -----------------------------

        /**
         * 调用Gemini API分析项目
         */
        async function callGeminiAPI(projectName, factory, goal) {
            // 定义AI的角色和任务
            const systemPrompt = `你是一名专业的AI能力文档整理助手。
你的任务是分析所提供的项目信息（项目名称、工厂名称、项目目标），并严格按照“图像AI能力画像”的客观、中立、描述性风格输出。
你必须严格按照下面定义的JSON格式返回结果。

- "applicationScenario": 用一句话总结该项目的实际应用场景，突出业务背景但避免价值评估。
- "processingObject": 说明该AI项目接收的图像或视频来源，例如“工业相机拍摄的PCB板静态图像”。
- "coreFunctions": 以条目形式详细描述该AI项目的可实现功能点（支持多功能拆解）。必须是一个字符串数组。
- "outputFormat": 说明系统输出的形式，包括数据格式、接口协议、联动设备等。
- "deploymentMethod": 描述部署形态和硬件依赖。如无明确信息，返回"未明确"。`;

            // 定义API的JSON Schema
            const schema = {
                type: "OBJECT",
                properties: {
                    "applicationScenario": { "type": "STRING" },
                    "processingObject": { "type": "STRING" },
                    "coreFunctions": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" }
                    },
                    "outputFormat": { "type": "STRING" },
                    "deploymentMethod": { "type": "STRING" }
                },
                required: ["applicationScenario", "processingObject", "coreFunctions", "outputFormat", "deploymentMethod"]
            };

            // 构建用户查询
            const userQuery = `请为以下项目生成AI能力画像：
- A列 (项目名称): ${projectName}
- B列 (工厂名称): ${factory}
- C列 (项目目标): ${goal}`;

            // ---- API 请求 ----
            const apiKey = ""; // 在Canvas环境中会自动提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 0.1 // 保持客观和一致性
                }
            };

            // 使用指数退避策略进行重试
            let response;
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // 成功，跳出循环
                    } else if (response.status === 429) { // 触发限流
                        throw new Error(`Rate limited. Retrying in ${delay / 1000}s...`);
                    } else {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                } catch (error) {
                    console.warn(error.message);
                    retries--;
                    if (retries === 0) throw error; // 最后一次重试失败，抛出错误
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // 指数退避
                }
            }
            
            const result = await response.json();

            // 解析返回的JSON
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } else {
                console.error("Invalid API response structure:", result);
                throw new Error("未从AI获取到有效的内容结构。");
            }
        }

        // -----------------------------
        // UI 辅助函数
        // -----------------------------

        /**
         * 设置加载状态
         */
        function setLoading(isLoading) {
            if (isLoading) {
                processButton.disabled = true;
                processButton.innerHTML = `
                    <div class="spinner w-5 h-5 border-2 border-white border-solid rounded-full"></div>
                    处理中...
                `;
            } else {
                processButton.disabled = false;
                processButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 001.414 1.414L9 11.414V14a1 1 0 102 0v-2.586l.293.293a1 1 0 001.414-1.414l-3-3z" clip-rule="evenodd" />
                    </svg>
                    开始处理
                `;
            }
        }

        /**
         * 显示状态消息
         */
        function showStatus(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('text-red-600', 'text-green-600', 'text-gray-600', 'text-blue-600');
            switch (type) {
                case 'error':
                    statusMessageEl.classList.add('text-red-600');
                    break;
                case 'success':
                    statusMessageEl.classList.add('text-green-600');
                    break;
                case 'loading':
                    statusMessageEl.classList.add('text-blue-600');
                    break;
                default:
                    statusMessageEl.classList.add('text-gray-600');
            }
        }

        /**
         * 创建表格行
         */
        function createResultRow(a, b, c, aiResult) {
            const tr = document.createElement('tr');
            tr.classList.add('hover:bg-gray-50');
            
            // F列：核心功能 (列表)
            const functionsList = aiResult.coreFunctions.length > 0
                ? `<ul class="list-disc list-inside">${aiResult.coreFunctions.map(f => `<li>${escapeHTML(f)}</li>`).join('')}</ul>`
                : '<span>未明确</span>';

            tr.innerHTML = `
                <td>${escapeHTML(a)}</td>
                <td>${escapeHTML(b)}</td>
                <td>${escapeHTML(c)}</td>
                <td>${escapeHTML(aiResult.applicationScenario)}</td>
                <td>${escapeHTML(aiResult.processingObject)}</td>
                <td id="core-functions">${functionsList}</td>
                <td>${escapeHTML(aiResult.outputFormat)}</td>
                <td>${escapeHTML(aiResult.deploymentMethod)}</td>
            `;
            return tr;
        }

        /**
         * 创建错误行
         */
        function createErrorRow(a, b, c, errorMsg) {
            const tr = document.createElement('tr');
            tr.classList.add('bg-red-50', 'text-red-700');
            tr.innerHTML = `
                <td>${escapeHTML(a)}</td>
                <td>${escapeHTML(b)}</td>
                <td>${escapeHTML(c)}</td>
                <td colspan="5" class="text-center font-medium">处理失败: ${escapeHTML(errorMsg)}</td>
            `;
            return tr;
        }

        /**
         * HTML转义
         */
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

    </script>
</body>
</html>
